#!/bin/bash

export RETRYONFAIL=1
export PATH=$PATH:$PWD
. .demoscript

clear
set -e

rm -rf testDir
doit mkdir testDir
doit cd testDir
cd testDir
doit --showcmd="ls -la" ls -la \| grep -v " out" \| grep -v " cmds"

doit azx init
comment "normally we'd ask for the subscription and resourceGroup"
doit --showcmd="ls -la" ls -la \| grep -v " out" \| grep -v " cmds"

doit azx add aca-app -n myapp -i duglin/aca-redis --environment=demo --ingress external

comment "lets look at the app"
doit cat .azx/stage_default/aca-app-myapp.json

doit azx up
comment check it on the web

comment "now lets create a redis service and provison at the same time"
doit azx add aca-redis -n myredis --environment=demo --provision

comment turn on auto-provision
doit azx set defaults.provision=true

doit azx update aca-app -n myapp --bind myredis
comment go look at the app

doit azx down

comment go look at the apps in the portal

comment see the files
doit ls .azx/stage_default
doit cat .azx/stage_default/*

comment recreate everything in Azure
doit azx up

doit azx down
