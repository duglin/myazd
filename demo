#!/bin/bash

export RETRYONFAIL=1
export PATH=$PATH:$PWD
. .demoscript

clear
set -e

rm -rf testDir
doit mkdir testDir
doit cd testDir
cd testDir
doit --showcmd="ls -la" ls -la \| grep -v " out" \| grep -v " cmds"

doit azx init
comment "normally we'd ask for the subscription and resourceGroup"
doit --showcmd="ls -la" ls -la \| grep -v " out" \| grep -v " cmds"

doit azx add aca-app -n myapp -i duglin/aca-redis --environment=demo --ingress external

comment List the resources in the project
doit azx list

comment "lets look at the app"
doit azx show aca-app -n myapp

doit azx up
comment check it on the web

comment "now lets create a redis service and provison at the same time"
doit azx add aca-redis -n myredis --environment=demo --provision

comment turn on auto-provision
doit azx set defaults.provision=true

doit azx update aca-app -n myapp --bind myredis
doit azx show aca-app -n myapp
comment go look at the app in the portal

doit azx down --wait

comment portal should not show app or service

comment see the files
doit ls .azx/stage_default
doit cat .azx/stage_default/*

comment recreate everything in Azure
doit azx up

doit azx down
