#!/bin/bash

export RETRYONFAIL=1
. .demoscript

clear
set -e

comment "Simple (non-ingress) ACA App"
doit cat acaApp.json
comment "This is the same JSON as Azure REST API, with 2 extra fields at top"

comment "Use azd to add (deploy) it"
doit azd add acaApp.json

comment "Check its status"
doit azd get acaApp.json

comment "Can use this for any Azure resource, try Redis Cache"
doit cat redis.json
doit azd add redis.json

comment "We can readd the same ACA file and it'll be idempotent"
doit azd add acaApp.json

comment "We can delete the app too"
doit azd delete acaApp.json

comment "Now let's deploy an ACA dev-mode Redis"
doit cat acaRedis.json
doit azd add acaRedis.json

comment "Now we can redeploy the app but this time include bindings & ingress"
doit cat acaAppBind.json
doit azd add acaAppBind.json

comment "Check status"
doit azd get acaRedis.json acaAppBind.json

comment "Curl the app to prove the env vars were injected"
doit curl -s "http://poc.orangetree-90dcdba8.eastus.azurecontainerapps.io?envs"

comment "We can also combine files"
doit cat one.json
doit azd add one.json

comment "Or use references/includes"
doit cat ref.json
doit azd add ref.json

comment "Or use http refs to the json"
comment "Useful to deploy someone else's apps w/o downloading anything"
doit curl -s https://raw.githubusercontent.com/duglin/myazd/master/ref.json
doit azd add https://raw.githubusercontent.com/duglin/myazd/master/ref.json

comment "Now delete them both"
doit azd delete one.json

comment "Check status"
doit azd get one.json
